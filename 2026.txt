我理解你遇到的问题：多个 Ingress 创建了多个 ALB,导致子网 IP 地址不足。以下是几种解决方案:

## 1. 使用 IngressGroup 合并多个 Ingress(推荐)

AWS Load Balancer Controller 支持通过 `IngressGroup` 将多个 Ingress 合并到同一个 ALB:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-1
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/group.name: my-group  # 关键:相同的 group name
    alb.ingress.kubernetes.io/group.order: '10'     # 优先级
spec:
  ingressClassName: alb
  rules:
  - host: app1.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service-1
            port:
              number: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-2
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/group.name: my-group  # 同一个 group
    alb.ingress.kubernetes.io/group.order: '20'
spec:
  ingressClassName: alb
  rules:
  - host: app2.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service-2
            port:
              number: 80
```

## 2. 在单个 Ingress 中配置多个规则

将所有路由规则合并到一个 Ingress 资源:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: unified-ingress
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
spec:
  ingressClassName: alb
  rules:
  - host: app1.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service-1
            port:
              number: 80
  - host: app2.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: service-2
            port:
              number: 80
  - host: app3.example.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: service-3
            port:
              number: 8080
```

## 3. 扩展子网 IP 地址(治标)

如果必须保留多个 ALB:

- **添加新子网**:创建更大的子网或添加额外子网
- **使用辅助 CIDR**:为 VPC 添加辅助 CIDR 块
- **清理未使用的 ENI**:检查并删除僵尸网络接口

```bash
# 检查子网可用 IP
aws ec2 describe-subnets --subnet-ids subnet-xxx \
  --query 'Subnets[*].[SubnetId,AvailableIpAddressCount]'
```

## 4. 迁移步骤

如果你要将现有的多个 Ingress 合并:

```bash
# 1. 备份现有配置
kubectl get ingress -A -o yaml > ingress-backup.yaml

# 2. 更新 Ingress 添加 group.name annotation
kubectl annotate ingress <ingress-name> \
  alb.ingress.kubernetes.io/group.name=my-group

# 3. 验证 ALB 合并
kubectl get ingress -A
# 检查 AWS Console 确认只有一个 ALB

# 4. 删除旧的独立 Ingress(如需要)
```

## 注意事项

- IngressGroup 中的所有 Ingress 必须使用相同的 `scheme` (internet-facing 或 internal)
- `group.order` 决定规则优先级,数字越小优先级越高
- 确保不同 Ingress 的规则不冲突(特别是 host 和 path 的组合)
- 合并后,ALB 的监听器规则会包含所有 Ingress 的路由


使用 IngressGroup 是最优雅的解决方案,可以在不改变应用架构的情况下共享 ALB,大大节省 IP 地址和成本。
claude 

下面把「用 IngressGroup 把 N 个 Ingress 压成 1 个 ALB」的 全部细节、命令、排错、回滚 再完整给一遍，复制即可用。
目标：10 min 内收回 (N-1)×2 个私有 IP，解决 subnet 只剩 2 个 IP 的燃眉之急。
一、前置确认（30 s）

    集群用的是 AWS Load Balancer Controller ≥ v2.2.0（EKS 1.19+ 默认已满足）。
    查看当前 ALB 数量（下面命令能直接看到每个 ALB 占 2 个子网 IP）：

bash
复制

aws elbv2 describe-load-balancers \
  --query 'LoadBalancers[?Type==`application`]' \
  --output table | grep -E 'LoadBalancerName|Subnet'

    记录剩余 IP：

bash
复制

aws ec2 describe-subnets --subnet-ids <subnet-xxx> \
  --query 'Subnets[0].AvailableIpAddressCount'

二、合并操作（5 步，全部在线完成）
表格
复制
步骤	动作	命令/示例	效果
1	选「保留 ALB」	挑域名/证书/WAF 已配好的那条 Ingress，记下名字，例如 ingress-main	后续所有规则都合并到它上面
2	给「保留 ALB」打 group（如果之前没打）	kubectl annotate ingress ingress-main alb.ingress.kubernetes.io/group.name=shared-alb	它成为主 ALB
3	把其余 Ingress 统统塞进同一个 group	批量 patch：
kubectl get ingress -A -o json | jq -r '.items[] | select(.metadata.annotations["kubernetes.io/ingress.class"]=="alb" and .metadata.annotations["alb.ingress.kubernetes.io/group.name"]!="shared-alb") | "\(.metadata.namespace)/\(.metadata.name)"' | xargs -I {} kubectl annotate ingress {} -n $(echo {} | cut -d/ -f1) alb.ingress.kubernetes.io/group.name=shared-alb	每改一条，controller 把规则追加到主 ALB，旧 ALB 被删除 → +2 IP
4	观察 ALB 数量实时下降	watch -n 5 'aws elbv2 describe-load-balancers --query "length(LoadBalancers[?Type==\application`])"'`	数字每减 1，IP 数 +2
5	确认 IP 已释放	aws ec2 describe-subnets --subnet-ids <subnet-xxx> --query 'Subnets[0].AvailableIpAddressCount'	通常 3 min 内从 2 → 10+
三、YAML 最小示范（单文件多 Ingress 写法）
主 Ingress（已存在）：
yaml
复制

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-main
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internal
    alb.ingress.kubernetes.io/group.name: shared-alb   # 关键
spec:
  rules:
  - host: api.a.com
    http:
      paths:
      - path: /
        backend:
          service:
            name: svc-a
            port: 80

第二条 Ingress（准备合并）：
yaml
复制

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-b
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/group.name: shared-alb   # 与上面相同
spec:
  rules:
  - host: api.b.com
    http:
      paths:
      - path: /
        backend:
          service:
            name: svc-b
            port: 80

kubectl apply 后，不会 再出现新 ALB，只是主 ALB 的监听规则里多出一条主机头路由。
四、常见报错与处理
表格
复制
报错/现象	原因	解决
Duplicate listener port	两条 Ingress 同时声明了 80 或 443 且证书不一致	把证书统一到一条 Ingress，或使用 tls.crt 字段合并证书
TooManyCertificates	单个监听证书 >25 张	拆分不同 hostname 到不同监听（如 443 与 8443），或买通配符证书
ALB not deleted	还有 Ingress 或 Service 类型 LoadBalancer 在引用	kubectl get ingress -A 确认 group 名全部一致；kubectl get svc -A 看有没有 type: LoadBalancer 也挂到同子网
五、防反弹：让以后再也乱建不出新 ALB

    给 Controller 加默认 group（Helm 值）：

--set defaultIngressGroup=shared-alb
升级一次即可，以后用户不写 group.name 也会落进这个组。
2. CI 门禁（GitLab-CI 片段）：
yaml
复制

script:
  - yq e '.metadata.annotations["alb.ingress.kubernetes.io/group.name"]' ingress.yaml | grep -q shared-alb

不通过就拒绝 MR，根治人为疏忽。
六、秒级回滚（万一合并后冲突）
把某条 Ingress 踢出 group，立即单独再起一个 ALB：
bash
复制

kubectl annotate ingress <name> alb.ingress.kubernetes.io/group.name-

controller 30 s 内会新建 ALB 并恢复原 DNS，业务无感知。
七、效果总结
表格
复制
指标	合并前	合并后（示例 6 个 Ingress）
ALB 数量	6	1
占用 subnet IP	12	2
剩余 IP	2	12
费用变化	6×$0.0225×24=$3.24/天	1×$0.0225×24=$0.54/天
一句话：把全部 Ingress 的 group.name 写成同一个字符串，3 分钟就能收回 (N-1)×2 个私有 IP，subnet 立刻松掉，后续再扩容节点也不慌。祝顺利！
aws elbv2 describe-load-balancers \
  --query 'LoadBalancers[?Type==`application`]' \
  --output table | grep -E 'LoadBalancerName|Subnet' 本地办公机器是win 没有grep
编辑
复制
分享
在 Windows 本地办公机（PowerShell 或 CMD）里，可以用 PowerShell 原生命令 代替 grep，效果完全一样：
PowerShell 一行版（直接复制）
powershell
复制

aws elbv2 describe-load-balancers --query 'LoadBalancers[?Type==`application`]' --output json |
  ConvertFrom-Json |
  ForEach-Object {
    [PSCustomObject]@{
      LoadBalancerName = $_.LoadBalancerName
      Subnets          = $_.Subnets -join ','
    }
  } | Format-Table -AutoSize

如果想 保留 table 样式 并且只抓关键列，再精简一点：
powershell
复制

aws elbv2 describe-load-balancers --query 'LoadBalancers[?Type==`application`].[LoadBalancerName,Subnets]' --output table

CMD 无 grep 的替代方案
CMD 里没有 grep，但可以装 Git Bash 或 WSL；
如果只能用 CMD，可先把结果写文件再 findstr：
cmd
复制

aws elbv2 describe-load-balancers --query "LoadBalancers[?Type=='application'].[LoadBalancerName,Subnets]" --output table > albs.txt
findstr /R "LoadBalancerName subnet" albs.txt

最简建议
装个 Git Bash（自带 grep、awk、jq），以后所有 Linux 命令都能用；
或者直接用 PowerShell 里的 ConvertFrom-Json 即可，无需额外软件。

**************

明白了，你们不是单纯想“少几个 ALB”，而是  
**「每个 ALB 强制占用 2 个私有 IP（两个 AZ 各 1 个）→ subnet IP 快被吃完」**  
所以目标是：  
1. 把现有一堆 ALB 合并成 1 个，**立刻回收 (N-1)×2 个 IP**；  
2. 以后尽量不再拆出新的 ALB，保证 subnet 不再爆。  

下面给出在 EKS 场景下**最快速、低风险、可回滚**的“IP 抢救”步骤，全部围绕「减少 ALB 数量」这一件事，不碰节点 CIDR，不改 CNI，10 min 内可落地。

------------------------------------------------
一、1 min 盘点：到底被谁吃掉了 IP
```bash
# 1. 看 subnet 剩余
aws ec2 describe-subnets --subnet-ids \
  subnet-0xxx subnet-1xxx \
  --query 'Subnets[*].[SubnetId,AvailableIpAddressCount]'

# 2. 看这些 subnet 上挂了多少 ALB
aws elbv2 describe-load-balancers --query \
  'LoadBalancers[?contains(`["subnet-0xxx","subnet-1xxx"]`, Subnets[0].SubnetId)].{DNS:DNSName,Type:Type,Name:LoadBalancerName}' \
  --output table
```
通常会发现 5~10 个 “k8s-cluster1/2/3…” 命名的 ALB，全是 Ingress 自动创建的。

------------------------------------------------
二、5 min 合并：把 N 个 ALB 压成 1 个
1. 选一个「保留 ALB」  
   挑域名/证书已经配置好、WAF 已绑定的那条，记下它的  
   `group.name`（annotation 里写的，默认是 “” 空字符串）。

2. 把其余 Ingress 全部改到同一个 group  
   给所有要合并的 Ingress 打一样的 annotation：
   ```yaml
   alb.ingress.kubernetes.io/group.name: "shared-alb"   # 任意字符串，只要统一
   alb.ingress.kubernetes.io/group.order: "10"         # 可选，控制规则顺序
   ```
   可以用 kubectl patch 一键打：
   ```bash
   kubectl patch ingress ingress-a -p \
     '{"metadata":{"annotations":{"alb.ingress.kubernetes.io/group.name":"shared-alb"}}}'
   ```
   每改一个，AWS 控制器会把规则追加到「保留 ALB」的监听下面，同时把旧 ALB 标记为 “unused” 并在后台删除，**2~3 min 内释放 2 个 IP**。

3. 验证 IP 是否已释放
   ```bash
   watch -n 5 'aws ec2 describe-subnets --subnet-ids subnet-0xxx \
     --query "Subnets[0].AvailableIpAddressCount"'
   ```
   每删一个 ALB，AvailableIpAddressCount +2。

------------------------------------------------
三、防反弹：以后再也不让 Ingress 乱建 ALB
1. 集群级默认强制统一 group  
   给 AWS Load Balancer Controller 加参数（ Helm 值 ）：
   ```
   defaultIngressGroup: shared-alb
   ```
   以后任何人不写 `group.name` 也会自动落进 “shared-alb”，不会再默默新建 ALB。

2. 加一条 CI 门禁  
   在 GitLab/GitHub CI 里做 yaml 静态扫描，只要出现  
   `kubernetes.io/ingress.class: alb` 且没有 `group.name: shared-alb` 就拒绝 MR，彻底根治。

------------------------------------------------
四、极限场景：实在不能合并，还有 3 个备用方案
| 方案 | 释放 IP 数量 | 工作量 | 备注 |
|---|---|---|---|
| 1. 把 ALB 从“internal” 改成 “internet-facing” 并迁到别的 subnet | 2*N | 5 min | 只需改 annotation `scheme`+subnet 标签，零中断 |
| 2. 启用 IPv6（双栈） | 大量 | 中 | 节点/pod 走 IPv6，ALB 仍占 IPv4，但可缓一缓 |
| 3. 直接扩 subnet CIDR | 无限 | 10 min | 把 subnet 掩码从 /24 → /23，需滚动节点，最彻底 |

------------------------------------------------
五、回滚预案
万一合并后监听/证书冲突，30 秒内可回滚：  
```bash
kubectl annotate ingress ingress-a alb.ingress.kubernetes.io/group.name-
```
控制器会立即给该 Ingress 单独再起一个 ALB，原配置不变。

------------------------------------------------
六、总结一句话
**“给所有 Ingress 打同一个 group.name，3 min 就能收回 (N-1)×2 个 IP，subnet 立刻松一口气；再加一条默认 group 门禁，以后不会再爆。”**  
照着做，今晚就能让 subnet 剩余 IP 从 2 个变成 10+，先救命，再考虑后续扩容。祝操作顺利！

###
仅凭名称 “ELB app/k8s-default-wexx-2444/dfb” 无法 100 % 断定它到底是 ALB、NLB 还是 CLB，但可以用下面 2 种办法在 10 秒内确认：

----------------------------------------
1. AWS CLI（最准）
```bash
aws elbv2 describe-load-balancers \
  --query 'LoadBalancers[?LoadBalancerName==`k8s-default-wexx-2444`] | [0].[Type,DNSName,LoadBalancerArn]'
```
- 返回 `"Type" : "application"`  → ALB  
- 返回 `"Type" : "network"`     → NLB  
- 报错 “LoadBalancerNotFound” → 再去 classic 里查：
```bash
aws elb describe-load-balancers \
  --query 'LoadBalancerDescriptions[?LoadBalancerName==`k8s-default-wexx-2444`] | [0].[DNSName]'
```
能查到就是旧版 CLB。

----------------------------------------
2. 控制台/控制台 URL
登录 EC2 → Load Balancers → 搜索 “wexx-2444”  
- 图标是 “ALB” 或 “NLB” 直接写明；  
- 如果页面跳转到 “Classic Load Balancer” 就是 CLB。

----------------------------------------
快速判断小技巧（仅辅助）
- 名字里带 “k8s-” 且后面是一串随机字符串，99 % 是 EKS 的 **ingress-controller 自动创建的 ALB**；  
- 如果 DNS 名以 “*-123456789.region.elb.amazonaws.com” 结尾，也是 ALB/NLB 特征；  
- 以 “*-123456789.region.ec2.elb.amazonaws.com” 结尾则是 CLB。

结论：  
**先用第一条 CLI 命令，秒级就能知道它是 ALB、NLB 还是 CLB**；肉眼猜不如一行命令准。


import boto3

ec2_client= boto3.client('ec2')
all_available_vpcs = ec2_client.describe_vpcs()
print(all_available_vpcs["Vpcs"])
