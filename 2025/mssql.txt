aws rds add-option-to-option-group \
  --option-group-name sqlserver-audit-option-group \
  --options OptionName=SQLSERVER_AUDIT,OptionSettings=[{Name=S3_BUCKET_ARN,Value=arn:aws:s3:::your-rds-audit-logs},{Name=IAM_ROLE_ARN,Value=arn:aws:iam::YOUR_ACCOUNT_ID:role/rds-sqlserver-audit-role},{Name=RETENTION_TIME,Value=24},{Name=ENABLE_COMPRESSION,Value=false}] \
  --apply-immediately

s3 
aws s3api create-bucket \
  --bucket my-sqlserver-audit-bucket \
  --region ap-southeast-1 \
  --create-bucket-configuration LocationConstraint=ap-southeast-1

创建信任策略文件（trust-policy.json）

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "rds.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}

创建角色

aws iam create-role \
  --role-name myRdsAuditRole \
  --assume-role-policy-document file://trust-policy.json

给角色附加 S3 写入权限
aws iam put-role-policy \
  --role-name myRdsAuditRole \
  --policy-name RDSAuditToS3Policy \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "s3:PutObject",
          "s3:ListBucket"
        ],
        "Resource": [
          "arn:aws:s3:::my-sqlserver-audit-bucket",
          "arn:aws:s3:::my-sqlserver-audit-bucket/*"
        ]
      }
    ]
  }'

aws iam put-role-policy --role-name myRdsAuditRole --policy-name RDSAuditToS3Policy --policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":["s3:PutObject","s3:ListBucket"],"Resource":["arn:aws:s3:::my-sqlserver-audit-bucket","arn:aws:s3:::my-sqlserver-audit-bucket/*"]}]}'

policy.json
 {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-sqlserver-audit-bucket",
        "arn:aws:s3:::my-sqlserver-audit-bucket/*"
      ]
    }
  ]
}

aws iam put-role-policy --role-name myRdsAuditRole --policy-name RDSAuditToS3Policy --policy-document file://policy.json


4️⃣ 获取 Role ARN
aws iam get-role --role-name myRdsAuditRole \
  --query "Role.Arn" --output text



aws rds describe-option-groups \
  --option-group-name <原OptionGroup名称> \
  --region <你的Region>


aws rds add-option-to-option-group \
  --option-group-name sqlserver-prod-options \
  --options "OptionName=SQLSERVER_AUDIT,OptionSettings=[
    {Name=S3_BUCKET_ARN,Value=arn:aws:s3:::my-audit-bucket},
    {Name=IAM_ROLE_ARN,Value=arn:aws:iam::123456789012:role/myRdsAuditRole},
    {Name=RETENTION_TIME,Value=24},
    {Name=ENABLE_COMPRESSION,Value=false}
  ]" \
##  --apply-immediately



aws rds create-option-group \
  --option-group-name sqlserver-prod-copy \
  --engine-name sqlserver-ee \
  --major-engine-version 15.00 \
  --option-group-description "Copied from sqlserver-prod-optiongroup" \
  --region ap-southeast-1


aws rds add-option-to-option-group \
  --option-group-name sqlserver-prod-copy \
  --options "OptionName=SQLSERVER_BACKUP_RESTORE" \
  --apply-immediately \
  --region ap-southeast-1


aws rds add-option-to-option-group \
  --option-group-name sqlserver-prod-copy \
  --options "OptionName=SQLSERVER_AUDIT,OptionSettings=[{Name=S3_BUCKET_ARN,Value=arn:aws:s3:::my-audit-bucket},{Name=IAM_ROLE_ARN,Value=arn:aws:iam::123456789012:role/myRdsAuditRole},{Name=ENABLE_COMPRESSION,Value=false},{Name=RETENTION_TIME,Value=24}]" \
  --apply-immediately \
  --region ap-southeast-1

  aws rds describe-option-groups \
  --option-group-name sqlserver-prod-copy \
  --region ap-southeast-1




###
aws rds copy-option-group \
  --source-option-group-identifier <源OptionGroup名称> \
  --target-option-group-identifier <新OptionGroup名称> \
  --target-option-group-description "<新OptionGroup的描述>" \
  [--tags Key=Name,Value=tagname]


aws rds copy-option-group \
  --source-option-group-identifier sqlserver-prod-audit-group \
  --target-option-group-identifier sqlserver-dr-audit-group \
  --target-option-group-description "DR site audit config" \
  --region ap-east-1 \
  --tags Key=Environment,Value=DR


三、将新 Option Group 应用到实例

当复制好后，你可以把它关联到你的 RDS SQL Server 实例：

aws rds modify-db-instance \
  --db-instance-identifier rds-sqlserver-prod \
  --option-group-name sqlserver-test-audit-group \
  --apply-immediately

